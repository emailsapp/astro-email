---
import fs from "node:fs";
import path from "node:path";
import archiver from "archiver";

let failed = false;

async function findTemplates(
	basePath: string,
	relativePath: string = "",
	currentDepth: number = 0,
	maxDepth: number = 2,
): Promise<any[]> {
	if (currentDepth > maxDepth) {
		return [];
	}

	const fullPath = path.resolve(basePath, relativePath);
	const items = fs.readdirSync(fullPath);
	const results: any[] = [];

	for (const item of items) {
		const itemPath = path.resolve(fullPath, item);
		const stat = fs.statSync(itemPath);

		try {
			if (stat.isDirectory()) {
				const subResults = await findTemplates(
					basePath,
					path.join(relativePath, item),
					currentDepth + 1,
					maxDepth,
				);
				results.push(...subResults);
			} else {
				const astroPageRaw = await import(`${itemPath}?raw`);
				const frontMatterMatch = astroPageRaw.default?.match(
					/^---\s*([\s\S]*?)\s*---/,
				);

				// Extract only export statements from frontmatter
				let exportStatements = "";
				if (frontMatterMatch) {
					const frontMatter = frontMatterMatch[1];
					const exportMatches = frontMatter.match(
						/export\s+[\s\S]*?(?=export\s+|$)/g,
					);
					if (exportMatches) {
						exportStatements = exportMatches.join("\n");
					}
				}

				const frontMatterToProcess = exportStatements || "";

				let exprts = {};

				// TODO: This limits us to not use relative file imports. Why cant we import astro file here at build time.
				if (frontMatterMatch) {
					const frontMatterModule = await import(
						`data:text/javascript,${encodeURIComponent(frontMatterToProcess)}`
					);
					exprts = frontMatterModule;
				}

				const templateName = (
					relativePath ? path.join(relativePath, item) : item
				).replace(".astro", "");

				// Check if getStaticPaths exists and generate multiple pages if so
				if (
					exprts.getStaticPaths &&
					typeof exprts.getStaticPaths === "function"
				) {
					const staticPaths = await exprts.getStaticPaths();

					for (const pathData of staticPaths) {
						let pageName = templateName;
						for (const key in pathData.params) {
							pageName = pageName.replace(`[${key}]`, pathData.params[key]);
						}

						results.push({
							name: pageName,
							config: exprts.config,
							params: pathData.params,
						});
					}
				} else {
					results.push({
						name: templateName,
						config: exprts.config,
					});
				}
			}
		} catch (err) {
			console.error(err);
			failed = true;
		}
	}

	return results;
}

const templates = await findTemplates("src/pages", "", 0, 2);

if (failed) {
	throw new Error("Failed to build pages");
}

// Generate assets zip at build time
let assetsZipPath = null;
const distPath = path.resolve("dist");

async function createAssetsZip() {
	if (!fs.existsSync(distPath)) {
		console.log("No dist directory found, skipping assets zip creation");
		return null;
	}

	const zipPath = path.resolve("public", "assets.zip");

	// Ensure public directory exists
	if (!fs.existsSync("public")) {
		fs.mkdirSync("public", { recursive: true });
	}

	return new Promise((resolve, reject) => {
		const output = fs.createWriteStream(zipPath);
		const archive = archiver("zip", {
			zlib: { level: 9 },
		});

		output.on("close", () => {
			console.log(`Assets zip created: ${archive.pointer()} total bytes`);
			resolve(zipPath);
		});

		archive.on("error", (err) => {
			reject(err);
		});

		archive.pipe(output);
		archive.directory(distPath, false);
		archive.finalize();
	});
}

try {
	assetsZipPath = await createAssetsZip();
} catch (err) {
	console.warn("Failed to create assets zip:", err.message);
}
---

<html>
  <head>
    <title>Astro Email</title>

    <Fragment
      set:html={`
        <script id="data" type="application/json">${JSON.stringify(
          {
            pages: templates,
          },
          null,
          "  "
        )}</script>
      `}
    />
  </head>

  <body>
    <div class="layout">
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>Templates</h1>
          <button id="download-assets" class="download-button" data-has-assets={assetsZipPath ? "true" : "false"}>
            Download All Assets
          </button>
        </div>
        {
          templates.map((template, index) => {
            const path = template?.name.replace(".astro", "");
            return (
              <div class="button" data-template={path}>
                <a href={`#${path}`}>
                  <span class="template-number">{String(index + 1).padStart(2, '0')}</span>
                  <span class="template-name">{path}</span>
                </a>
                <a target="_blank" href={path} class="template-link">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em" style="margin-bottom:-2px;" viewBox="0 0 15 15">
                    <defs>
                      <clipPath id="clip-path">
                        <rect id="Rectangle_1687" data-name="Rectangle 1687" width="15" height="15" transform="translate(11726 152)" fill="none"/>
                      </clipPath>
                    </defs>
                    <g id="Mask_Group_3" data-name="Mask Group 3" transform="translate(-11726 -152)" clip-path="url(#clip-path)">
                      <g id="Group_422" data-name="Group 422" fill="currentColor">
                        <path id="Path_4182" data-name="Path 4182" d="M14.6,14H7.4A2.4,2.4,0,0,1,5,11.6V4.4A2.4,2.4,0,0,1,7.4,2h2.8V3.2H7.4A1.2,1.2,0,0,0,6.2,4.4v7.2a1.2,1.2,0,0,0,1.2,1.2h7.2a1.2,1.2,0,0,0,1.2-1.2V9H17v2.6A2.4,2.4,0,0,1,14.6,14Z" transform="translate(11722 152)"/>
                        <path id="Path_4181" data-name="Path 4181" d="M3.385,9.591V1.927L.963,4.349a.564.564,0,0,1-.8-.8L3.54.176a.564.564,0,0,1,.684-.1h0l.01.006,0,0,.007,0,.006,0,0,0L4.264.1h0a.567.567,0,0,1,.083.069L7.733,3.55a.564.564,0,0,1-.8.8L4.513,1.926V9.591a.564.564,0,1,1-1.128,0Z" transform="translate(11737.298 150.117) rotate(45)"/>
                      </g>
                    </g>
                  </svg>
                </a>
              </div>
            );
          })
        }
      </div>

      <div class="preview">
        <div id="display-width" class="preview-header"></div>
        <iframe width="640px"></iframe>

        <script>
          const dataString = document.querySelector("#data")?.innerHTML;
          if (!dataString) throw new Error("No data found");

          const data = JSON.parse(dataString);
          console.debug("data", data);

          // Download assets functionality
          const downloadButton = document.querySelector("#download-assets");
          const hasAssets = downloadButton && downloadButton.getAttribute("data-has-assets") === "true";

          if (downloadButton) {
            if (!hasAssets) {
              downloadButton.disabled = true;
              downloadButton.innerHTML = `
                <svg width="12" height="12" viewBox="0 0 12 12" style="color: #6c757d;">
                  <circle cx="6" cy="6" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M4.5 4.5l3 3M7.5 4.5l-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                No Assets Built
              `;
              downloadButton.title = "Run 'npm run build' to generate downloadable assets";
            } else {
              downloadButton.addEventListener("click", () => {
                // Simple direct download of pre-built zip
                const link = document.createElement("a");
                link.href = "/assets.zip";
                link.download = "assets.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success feedback
                const originalText = downloadButton.innerHTML;
                downloadButton.innerHTML = `
                  <svg width="12" height="12" viewBox="0 0 12 12" style="color: #22c55e;">
                    <path d="M2 6l2.5 2.5L9 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Downloaded!
                `;

                setTimeout(() => {
                  downloadButton.innerHTML = originalText;
                }, 1500);
              });
            }
          }

          const iframe = document.querySelector("iframe");
          if (!iframe) throw new Error("No iframe found");

          let fixedWidth = undefined;
          let fixedHeight = undefined;

          const updateFormat = (name?: string) => {
            const config = data.pages.find((temp: { name: string }) => {
              return temp.name === `${name}`;
            })?.config;

            fixedWidth = config.width;
            fixedHeight = config.height;
            const width = fixedWidth || iframe?.offsetWidth || 0;
            const height = fixedHeight || iframe?.offsetHeight || 0;

            const display = document.querySelector("#display-width");
            if(display) {
              display.innerHTML = `${width}x${height}px`;
            }

            if(iframe) {
              iframe.width = `${width}`;
              iframe.height = `${height}`;
            }
          }

          let resizeListener: EventListener;

          function showTemplate(name: string) {
            if(!iframe) return;

            const config = data.pages.find((temp: { name: string }) => {
              return temp.name === `${name}`;
            })?.config;

            console.debug(name, config)

            updateFormat(name);

            iframe.src = `/${name}`;

            // Update active state
            document.querySelectorAll('.button').forEach(button => {
              button.classList.remove('active');
            });

            const activeButton = document.querySelector(`[data-template="${name}"]`);
            if (activeButton) {
              activeButton.classList.add('active');
            }

            window.removeEventListener("resize", resizeListener);

            resizeListener = () => updateFormat(name);

            window.addEventListener("resize", resizeListener);
          }

          const template = location.hash.substring(1);
          if (template) {
            showTemplate(template)
          } else {
            const first = data.pages[0]?.name.replace(".astro", "");
            showTemplate(first)
          }

          window.addEventListener("hashchange", () => {
            showTemplate(location.hash.substring(1));
          });
        </script>
      </div>
    </div>

    <style>
      body {
        font-family: sans-serif, Arial;
        height: 100vh;
        margin: 0;
        overscroll-behavior: none;
        overflow: hidden;
        font-size: 1rem;
      }

      body {
        background-color: #e5e5f7;
        background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(to right, #eee 1px, #fff 1px);
        background-size: 20px 20px;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background-color: hsl(258, 7%, 10%);
          color: #fff;
        }
      }

      iframe {
        border: none;
        max-height: 100%;
        max-width: 100%;
        flex: none;
      }

      h1 {
        opacity: 0.65;
        font-size: 0.65rem;
        font-weight: normal;
        text-transform: uppercase;
        margin: 0;
      }

      .preview-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 5px 20px;
        font-size: 0.75rem;
        color: #666;
      }

      .preview {
        display: grid;
        grid-template-rows: auto 1fr;
        justify-content: center;
        justify-items: center;
        height: 100%;
        margin: 0 20px;
      }

      .layout {
        height: 100%;
        display: grid;
        grid-template-columns: 280px 1fr;
        grid-template-rows: 1fr;
      }

      .sidebar {
        margin: 8px;
        border-radius: 8px;
        background: #fff;
        padding: 1rem 0.75rem;
        box-sizing: border-box;
        border-right: 1px solid #e0e0e0;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar-header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .download-button {
        appearance: none;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-height: 2.25rem;
      }

      .download-button:hover:not(:disabled) {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      .download-button:disabled {
        opacity: 0.8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        background: #6c757d;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (prefers-color-scheme: dark) {
        .sidebar {
          background-color: hsl(258, 4%, 14%);
          border-right: 1px solid #000000;
        }
      }

      a[href] {
        color: inherit;
        text-decoration: none;
      }

      .button,
      button {
        display: inline-block;
        box-sizing: border-box;
        appearance: none;
        width: 100%;
        background: transparent;
        color: inherit;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0px 4px 0px 6px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
      }

      .button a[href^="#"] {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
        min-height: 2rem;
      }

      .template-number {
        font-size: 0.75rem;
        opacity: 0.6;
        font-weight: 600;
        min-width: 1.5rem;
        text-align: center;
      }

      .template-name {
        flex: 1;
        font-size: 0.8rem;
      }

      .button.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
      }

      .button.active .template-number {
        opacity: 0.9;
      }

      .template-link {
        font-size: 0.65rem;
        padding: 8px 10px;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .template-link:hover {
        background: #8282823e;
      }

      .button:hover,
      button:hover {
        box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.04);
      }

      .button:active,
      button:active {
        transition: none;
        box-shadow: none;
      }

      @media (prefers-color-scheme: dark) {
        button {
          border: 1px solid #4b4b4b;
        }

        button:hover {
          background: #3f3f3f;
        }

        .button.active {
          background: #0066cc;
          border-color: #0066cc;
        }

        .download-button:hover:not(:disabled) {
          background: #0056b3;
        }

        .download-button:disabled {
          background: #6c757d;
        }
      }
    </style>
  </body>
</html>
